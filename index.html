<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>배너 합성 사이트</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .preview-canvas { border: 1px solid #ccc; margin-top: 20px; }
        .btn-group { margin-bottom: 20px; }
        #preview-container { margin-top: 20px; }
    </style>
</head>
<body>

<h3>배너 합성 사이트</h3>

<div class="btn-group" role="group">
    <button class="btn btn-primary" id="btn-biz-2-1">Biz 2:1</button>
    <button class="btn btn-primary" id="btn-biz-1-1">Biz 1:1</button>
    <button class="btn btn-primary" id="btn-mo-2-1">Mo 2:1</button>
</div>

<div>
    <input type="file" id="image-upload" accept="image/*" multiple disabled>
</div>

<canvas id="preview-canvas" class="preview-canvas"></canvas>

<div class="mt-3">
    <button class="btn btn-success" id="download-btn" disabled>다운로드</button>
    <button class="btn btn-secondary" id="reset-btn">초기화</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>

let currentFormat = null;
const uploadInput = document.getElementById('image-upload');
const canvas = document.getElementById('preview-canvas');
const ctx = canvas.getContext('2d');
const downloadBtn = document.getElementById('download-btn');

const formats = {
    "biz-2-1": {
        width: 1029,
        height: 258,
        visualWidth: 315,
        visualHeight: 168,
        left: 48,
        top: 36,
        round: 15,
        type: "png",
        maxSize: 300
    },
    "biz-1-1": {
        width: 1029,
        height: 258,
        visualWidth: 232,
        visualHeight: 232,
        left: 260,
        top: 13,
        round: 15,
        type: "png",
        maxSize: 300
    },
    "mo-2-1": {
        width: 1200,
        height: 600,
        visualWidth: 1200,
        visualHeight: 497,
        left: 0,
        top: 193,
        round: 0,
        type: "jpg",
        maxSize: 500
    }
};

document.getElementById('btn-biz-2-1').onclick = () => setFormat('biz-2-1');
document.getElementById('btn-biz-1-1').onclick = () => setFormat('biz-1-1');
document.getElementById('btn-mo-2-1').onclick = () => setFormat('mo-2-1');
document.getElementById('reset-btn').onclick = resetAll;
downloadBtn.onclick = downloadImages;

function setFormat(formatKey) {
    currentFormat = formats[formatKey];
    uploadInput.disabled = false;
    uploadInput.value = '';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    canvas.width = currentFormat.width;
    canvas.height = currentFormat.height;
    downloadBtn.disabled = true;
}

uploadInput.onchange = () => {
    if (!currentFormat) return;

    const files = uploadInput.files;
    if (files.length === 0) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const zip = new JSZip();
    let processedCount = 0;

    Array.from(files).forEach(file => {
        const img = new Image();
        img.onload = () => {
            const ratioMatch = (img.width / img.height).toFixed(2) === (currentFormat.visualWidth / currentFormat.visualHeight).toFixed(2);
            if (!ratioMatch) {
                alert(`비율 불일치: ${file.name}`);
                processedCount++;
                if (processedCount === files.length) downloadBtn.disabled = false;
                return;
            }

            // 캔버스 초기화
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 둥근 모서리 마스크 적용
            if (currentFormat.round > 0) {
                ctx.save();
                roundRect(ctx, currentFormat.left, currentFormat.top, currentFormat.visualWidth, currentFormat.visualHeight, currentFormat.round);
                ctx.clip();
            }

            ctx.drawImage(img, currentFormat.left, currentFormat.top, currentFormat.visualWidth, currentFormat.visualHeight);

            if (currentFormat.round > 0) ctx.restore();

            // 다운로드용 개별 이미지 생성
            const outputType = currentFormat.type === "png" ? "image/png" : "image/jpeg";
            const dataUrl = canvas.toDataURL(outputType, 1.0);
            const base64 = dataUrl.split(',')[1];
            zip.file(file.name.replace(/\.[^/.]+$/, "") + "." + currentFormat.type, base64, { base64: true });

            processedCount++;
            if (processedCount === files.length) {
                downloadBtn.disabled = false;
                downloadBtn.zip = zip;
            }
        };
        img.src = URL.createObjectURL(file);
    });
};

function downloadImages() {
    downloadBtn.zip.generateAsync({ type: "blob" }).then(content => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = "banners.zip";
        a.click();
    });
}

function resetAll() {
    uploadInput.value = '';
    uploadInput.disabled = true;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    downloadBtn.disabled = true;
    currentFormat = null;
}

function roundRect(ctx, x, y, width, height, radius) {
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
}

</script>

</body>
</html>
